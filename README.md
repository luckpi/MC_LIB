# Motor_Control

电流采样：<b>双电阻采样</b></br>
角度估算：<b>滑膜估算器</b> + <b>反正切</b></br>
项目介绍：本项目基于HC32-F030J8TA(ARM Cortex-M0+内核)，通过双电阻采样<b>下管导通中间时刻</b>电流。通过基于<b>电机电流模型</b>构建的滑膜估算器，得到反电动势，经过两次低通滤波后反正切获取估算角。(需补偿90°的固定相位延时) </br>
Tip：不同电机，需要调整相电感，相电阻，工作电压，最大电流，启动的力矩。
* 基于公式的<b>弱磁</b>技术</br>
     $$V_{max} = V_{bus} \div \sqrt3$$
     $$V_{qref} = \sqrt[2]{Vmax^2 - Vd^2}$$
     $$I_d = (V_{qref} - R_s \times I_q - BEMF) \div Omega * L_s$$
     $$-I_{dmax} < I_d < 0$$
* 问题总结：  
    *  之前一直困扰我的切入闭环PI速度环问题，其实不是PI的锅，是因为相电流采样电路里的电容太大导致的信号延迟太高，使得估算角度的延时也变高了，通过加大延时就转起来了。
    * 之前用的反正切算法计算误差过大，容易卡死，使用<b>CORDIC</b>之后就变得稳定多了。
    * 采样电路使用 正向放大器 ,PCB布线尽可能的避开大电流 ，铺地时注意隔开
    * 一直切不进闭环的原因找到了，是反正切的计算参数问题，一直以为是电流采样滤波造成的相位延时。 
    * 有些电机的参数更改之后,可能还需要修改滑膜的最大误差(<b>MAXLINEARSMC</b>)和校准因子(<b>SMCGAIN</b>)   
<details>
<summary>电机电气参数</summary></br> 

| 名称         | 参数    | 单位 | 名称       | 参数 | 单位   |
| ------------ | ------- | ---- | ---------- | ---- | ------ |
| 电机型号     | 42BLF01 |      | 绕组形式   | 星形 |        |
| 传感器电角度 | 120     | °    | 峰值转矩   | 0.18 | Nm     |
| 磁极数       | 8       | 极   | 相数       | 3    | 相     |
| 线电阻       | 1.8     | Ω    | 线电感     | 1.08 | mH     |
| 额定电压     | 24      | V    | 峰值电流   | 4.6  | A      |
| 转矩常数     | 0.042   | Nm/A | 反电势常数 | 4.4  | V/krpm |
| 保持力矩     | 0.063   | Nm   | 转动惯量   | 24   | gcm^2  |
| 输出功率     | 26      | W    | 额定转速   | 4000 | rpm    |
</details>